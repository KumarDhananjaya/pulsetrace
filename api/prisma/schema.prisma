// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Identity & Access Management (IAM)
// -----------------------------------------------------------------------------

model User {
  id            String               @id @default(uuid())
  email         String               @unique
  password      String
  name          String?
  avatarUrl     String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  
  // Relations
  memberships   OrganizationMember[]
}

model Organization {
  id            String               @id @default(uuid())
  name          String
  slug          String               @unique // for URLs: app.pulsetrace.com/acme-corp
  plan          String               @default("FREE") // FREE, PRO, ENTERPRISE
  isPersonal    Boolean              @default(false)  // True if this is a user's personal workspace
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  
  // Relations
  members       OrganizationMember[]
  projects      Project[]
}

model OrganizationMember {
  id            String       @id @default(uuid())
  role          String       @default("MEMBER") // OWNER, ADMIN, MEMBER, VIEWER
  
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  orgId         String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  joinedAt      DateTime     @default(now())

  @@unique([userId, orgId])
}

// -----------------------------------------------------------------------------
// Telemetry Data
// -----------------------------------------------------------------------------

model Project {
  id            String       @id @default(uuid())
  name          String
  apiKey        String       @unique @default(uuid()) // The DSN private key for this project
  platform      String?      // web, mobile-ios, mobile-android, node
  
  orgId         String
  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  // Relations
  issues        Issue[]
  releases      Release[]
  monitors      Monitor[]
  logs          Log[]
}

model Release {
  id        String     @id @default(uuid())
  version   String     // e.g., "v1.0.0"
  
  projectId String
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  artifacts Artifact[]
  
  createdAt DateTime   @default(now())
  
  @@unique([projectId, version])
}

model Artifact {
  id        String   @id @default(uuid())
  filename  String   // e.g., "~/app.js"
  filepath  String   // Local path: "uploads/<project>/<release>/app.js"
  type      String   // "source_map" | "minified_source"
  size      Int
  
  releaseId String
  release   Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model Issue {
  id            String       @id @default(uuid())
  title         String
  fingerprint   String       // Hash of the stacktrace/error to deduplicate
  type          String       // 'Error', 'Exception', 'Crash'
  status        String       @default("unresolved") // unresolved, resolved, ignored
  
  projectId     String
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  firstSeen     DateTime     @default(now())
  lastSeen      DateTime     @default(now())
  eventsCount   Int          @default(0)
  usersAffected Int          @default(0)
  
  // Relations
  events        Event[]

  @@unique([projectId, fingerprint])
  @@index([projectId])
  @@index([lastSeen])
}

model Event {
  id            String       @id @default(uuid())
  eventId       String       @unique // Client-generated UUID
  timestamp     DateTime
  
  level         String       // info, warning, error, fatal
  message       String
  
  // Context Data (JSONB for flexibility)
  exception     Json?        // { type: "TypeError", value: "x is null", stacktrace: ... }
  breadcrumbs   Json?        // [ { type: "click", category: "ui", ... } ]
  metrics       Json?        // Performance metrics
  contexts      Json?        // { os: { name: "Mac OS" }, browser: { name: "Chrome" } }
  network       Json?        // { url: "...", method: "POST" }
  user          Json?        // { id: "123", email: "..." }
  tags          Json?        // { release: "v1.0.1", environment: "production" }
  environment   String?
  release       String?
  
  // Hierarchy
  issueId       String?
  issue         Issue?       @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime     @default(now())

  @@index([issueId])
  @@index([timestamp])
}

// -----------------------------------------------------------------------------
// Uptime Monitoring
// -----------------------------------------------------------------------------

model Monitor {
  id            String         @id @default(uuid())
  name          String
  url           String
  interval      Int            @default(60) // Check interval in seconds
  type          String         @default("http") // http, ping
  status        String         @default("up") // up, down, maintenance, paused
  lastCheck     DateTime?
  
  projectId     String
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  checks        MonitorCheck[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([projectId])
}

model MonitorCheck {
  id            String   @id @default(uuid())
  status        String   // up, down
  latency       Int      // ms
  statusCode    Int?
  message       String?
  
  monitorId     String
  monitor       Monitor  @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  
  timestamp     DateTime @default(now())
  
  @@index([monitorId])
  @@index([timestamp])
}

// -----------------------------------------------------------------------------
// Log Management
// -----------------------------------------------------------------------------

model Log {
  id          String   @id @default(uuid())
  level       String   // debug, info, warn, error, fatal
  message     String
  metadata    Json?    // for structured logging
  source      String?  // e.g. "backend", "frontend"
  timestamp   DateTime @default(now())
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([timestamp])
  @@index([level])
}
